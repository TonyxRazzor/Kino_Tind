{% extends 'base.html' %}

{% block content %}
    <h2>Раздел подбора фильмов</h2>

    {% if films_with_genres %}
        <div id="film-container">
            {% for item in films_with_genres %}
                {% with film=item.film %}
                    <div class="film-card film-data" data-film-id="{{ film.id }}">
                        <h3>
                            <a href="{% url 'films:film_detail' film.id %}">{{ film.name }}</a>
                        </h3>
                        <p>Год выпуска: {{ film.year }}</p>
                        <p>Жанр: 
                            {% for genre in item.genres %}
                                {{ genre.name }}
                                {% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p>Страна: {{ film.country }}</p>

                        {% if film.poster %}
                            <img src="{{ film.poster.url }}" alt="{{ film.name }} Poster" width="200">
                        {% endif %}

                        <div class="button-container">
                            {% if item.film_choice %}
                                {% if item.film_choice.selection == 'yes' %}
                                    <p>Вы уже выбрали этот фильм</p>
                                {% elif item.film_choice.selection == 'no' %}
                                    <p>Вы отказались от этого фильма</p>
                                {% endif %}
                            {% else %}
                                <button class="btn btn-success select-film" data-film-id="{{ film.id }}" data-selection="yes" data-url="{% url 'users:confirm_match' %}">Да</button>
                                <button class="btn btn-danger select-film" data-film-id="{{ film.id }}" data-selection="no" data-url="{% url 'users:confirm_match' %}">Нет</button>
                            {% endif %}
                        </div>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% else %}
        <p>Извините, нет доступных фильмов.</p>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        checkForNotifications();

        $('.select-film').on('click', function() {
            var filmId = $(this).data('film-id');
            var selection = $(this).data('selection');
            var url = $(this).data('url');

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    'film_id': filmId,
                    'selection': selection,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // Добавление CSRF токена
                },
                success: function(response) {
                    if (response.success) {
                        window.location.href = '/users/confirm_match_result/' + response.film_id;

                        if ('Notification' in window) {
                            Notification.requestPermission().then(function(permission) {
                                if (permission === 'granted') {
                                    var notification = new Notification('Найдено совпадение!', {
                                        body: 'Нажмите, чтобы увидеть детали.',
                                        data: {
                                            url: '/users/confirm_match_result/' + response.film_id
                                        }
                                    });

                                    notification.onclick = function(event) {
                                        event.preventDefault();
                                        window.open(notification.data.url, '_blank');
                                    };
                                }
                            });
                        }
                    } else {
                        alert('Совпадение не найдено. Пожалуйста, выберите другой фильм.');
                        location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка:', error);
                }
            });
        });

        function checkForNotifications() {
            $.get("{% url 'users:check_notifications' %}", function(data) {
                if (data.notifications.length > 0) {
                    data.notifications.forEach(function(notification) {
                        alert(notification.title + ": " + notification.body);
                        // Дополнительно можно перенаправить пользователя на URL уведомления
                        if (notification.url) {
                            window.location.href = notification.url;
                        }
                    });
                }
            });
        }

        setInterval(checkForNotifications, 5000); // Проверка уведомлений каждые 5 секунд
    });

    function checkMatch() {
        fetch("{% url 'users:check_user_match' %}")
            .then(response => response.json())
            .then(data => {
                if (data.matched) {
                    alert(`Найдено совпадение для фильма ${data.title}`);
                    window.location.href = `/users/confirm_match_result/${data.film_id}/`;
                }
            })
            .catch(error => console.error('Error:', error));
    }

    setInterval(checkMatch, 5000);
</script>
{% endblock %}

